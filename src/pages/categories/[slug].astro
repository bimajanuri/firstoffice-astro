---
import BaseLayout from "../../layouts/BaseLayout.astro";
import OfficeCard from "../../components/OfficeCard.astro";
import offices from "../../data/offices.json";
import cities from "../../data/cities.json";
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
import bannerImage from "../../assets/images/backgrounds/banner.webp";

export const prerender = true;

// Get category from params
const { slug } = Astro.params;

// Define category mappings
const categoryMap: Record<string, string> = {
    "serviced-office": "Serviced Office",
    "virtual-office": "Virtual Office",
    "shell-and-core": "Shell and Core",
    "managed-office": "Managed Office",
};

const categoryDescriptions: Record<string, string> = {
    "serviced-office": "Ready-to-use offices with all amenities included.",
    "virtual-office":
        "Professional address and services without physical space.",
    "shell-and-core": "Unfurnished spaces ready for your custom fit-out.",
    "managed-office": "Tailored workspaces managed by a third-party provider.",
};

// Get the actual category name from slug
const categoryName = categoryMap[slug || ""];
const categoryDescription = categoryDescriptions[slug || ""];

// Check if category exists
if (!categoryName) {
    return Astro.redirect("/categories");
}

// Filter offices by category
const filteredOffices = offices.filter(
    (office) => office.category === categoryName,
);

const title = `${categoryName} - FirstOffice`;

// Generate static paths for build
export async function getStaticPaths() {
    return [
        { params: { slug: "serviced-office" } },
        { params: { slug: "virtual-office" } },
        { params: { slug: "shell-and-core" } },
        { params: { slug: "managed-office" } },
    ];
}
---

<BaseLayout title={title}>
    <header class="flex flex-col w-full">
        <section
            id="Hero-Banner"
            class="relative flex flex-col lg:block lg:h-[434px]"
        >
            <div
                id="Hero-Text"
                class="relative z-10 flex flex-col w-full px-4 mt-8 lg:mt-[70px] lg:ml-[calc((100%-1130px)/2)] lg:w-full lg:max-w-[650px] h-fit rounded-[30px] border border-[#E0DEF7] p-6 lg:p-10 gap-6 lg:gap-[30px] bg-white"
            >
                <div
                    class="flex items-center w-fit rounded-full py-2 px-4 gap-[10px] bg-[#000929]"
                >
                    <span class="font-semibold text-white text-sm lg:text-base"
                        >{categoryName}</span
                    >
                </div>
                <h1
                    class="font-extrabold text-[36px] lg:text-[50px] leading-[46px] lg:leading-[60px]"
                >
                    Browse <br />
                    <span class="text-[#0D903A]">{categoryName}s</span>
                </h1>
                <p
                    class="text-base lg:text-lg leading-7 lg:leading-8 text-[#000929]"
                >
                    {categoryDescription}
                </p>
                <div
                    class="flex items-center gap-2 text-sm lg:text-base text-gray-600"
                >
                    <span class="font-semibold text-[#0D903A]"
                        >{filteredOffices.length}</span
                    >
                    {
                        filteredOffices.length === 1
                            ? "office available"
                            : "offices available"
                    }
                </div>
            </div>
            <div
                id="Hero-Image"
                class="mt-8 lg:mt-0 w-full lg:absolute lg:right-0 lg:top-0 lg:w-[calc(100%-((100%-1130px)/2)-305px)] h-[300px] lg:h-[434px] rounded-[30px] lg:rounded-bl-[40px] overflow-hidden"
            >
                <Image
                    src={bannerImage}
                    class="w-full h-full object-cover"
                    alt="hero background"
                />
            </div>
        </section>
    </header>

    <!-- Offices Grid -->
    <section
        class="w-full max-w-screen-xl mx-auto px-4 my-10 lg:my-[70px] flex flex-col gap-[30px]"
    >
        {
            filteredOffices.length > 0 && (
        <div
            class="flex flex-col gap-4"
        >
            <div
                class="flex flex-col md:flex-row items-center justify-between gap-4"
            >
                <div class="flex items-center gap-2">
                    <h2 class="font-bold text-xl leading-[30px] text-[#000929]">
                        Showing <span id="result-count" class="text-[#0D903A]">{filteredOffices.length}</span> Offices
                    </h2>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-[#000929] font-medium">Sort by:</span>
                    <div class="relative">
                        <select
                            id="sort-select"
                            class="appearance-none bg-white border border-[#E0DEF7] rounded-full px-5 py-3 pr-10 text-[#000929] font-semibold focus:outline-none focus:ring-2 focus:ring-[#0D903A] cursor-pointer"
                        >
                            <option value="recommended">Recommended</option>
                            <option value="price-low">Lowest Price</option>
                            <option value="price-high">Highest Price</option>
                            <option value="rating">Highest Rating</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#000929]"
                        >
                            <Icon name="lucide:chevron-down" class="w-4 h-4" />
                        </div>
                    </div>
                </div>
            </div>

             <!-- Filters -->
             <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 p-5 rounded-[20px] border border-[#E0DEF7] bg-white">
                <!-- City Filter -->
                <div class="flex flex-col gap-2">
                    <label for="filter-city" class="font-bold text-[#000929]">City</label>
                    <div class="relative">
                         <select
                            id="filter-city"
                            class="w-full appearance-none bg-white border border-[#E0DEF7] rounded-full px-4 py-2 pr-10 text-[#000929] font-medium focus:outline-none focus:ring-2 focus:ring-[#0D903A] cursor-pointer"
                        >
                            <option value="">All Cities</option>
                            {cities.map((city) => (
                                <option value={city.name}>{city.name}</option>
                            ))}
                        </select>
                         <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#000929]"
                        >
                            <Icon name="lucide:chevron-down" class="w-4 h-4" />
                        </div>
                    </div>
                </div>

                <!-- Price Filter -->
                <div class="flex flex-col gap-2">
                    <label for="filter-price" class="font-bold text-[#000929]">Max Price</label>
                    <div class="relative">
                         <select
                            id="filter-price"
                            class="w-full appearance-none bg-white border border-[#E0DEF7] rounded-full px-4 py-2 pr-10 text-[#000929] font-medium focus:outline-none focus:ring-2 focus:ring-[#0D903A] cursor-pointer"
                        >
                            <option value="">Any Price</option>
                            <option value="10000000">&lt; Rp 10.000.000</option>
                            <option value="20000000">&lt; Rp 20.000.000</option>
                            <option value="50000000">&lt; Rp 50.000.000</option>
                            <option value="100000000">&lt; Rp 100.000.000</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#000929]"
                        >
                            <Icon name="lucide:chevron-down" class="w-4 h-4" />
                        </div>
                    </div>
                </div>

                <!-- Rating Filter -->
                 <div class="flex flex-col gap-2">
                    <label for="filter-rating" class="font-bold text-[#000929]">Rating</label>
                    <div class="relative">
                         <select
                            id="filter-rating"
                            class="w-full appearance-none bg-white border border-[#E0DEF7] rounded-full px-4 py-2 pr-10 text-[#000929] font-medium focus:outline-none focus:ring-2 focus:ring-[#0D903A] cursor-pointer"
                        >
                            <option value="">Any Rating</option>
                            <option value="4.5">4.5+ Stars</option>
                            <option value="4">4+ Stars</option>
                            <option value="3">3+ Stars</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#000929]"
                        >
                            <Icon name="lucide:chevron-down" class="w-4 h-4" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
            )
        }
        {
            filteredOffices.length > 0 ? (
                <>
                    <div
                        id="office-grid"
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-[30px]"
                    >
                        {filteredOffices.map((office, index) => (
                            <div
                                class={`office-card-item ${index >= 9 ? "hidden" : ""}`}
                                data-price={office.price}
                                data-rating={office.rating}
                                data-location={office.location}
                                data-category={office.category}
                            >
                                <OfficeCard office={office} />
                            </div>
                        ))}
                    </div>
                     {filteredOffices.length > 9 && (
                        <div id="load-more-container" class="flex justify-center mt-10">
                            <button
                                id="load-more-btn"
                                class="px-8 py-4 bg-white border border-[#E0DEF7] rounded-full font-bold text-[#000929] hover:bg-gray-50 transition-colors"
                            >
                                View More Offices
                            </button>
                        </div>
                    )}
                     <p id="no-results-msg" class="hidden text-center text-xl text-gray-500 mt-10">
                        No offices found matching your filters.
                    </p>
                </>
            ) : (
                <div class="flex flex-col items-center justify-center py-20 gap-4">
                    <p class="text-2xl text-gray-500 font-semibold">
                        No offices found in this category
                    </p>
                    <p class="text-lg text-gray-400">
                        Please check back later for new listings
                    </p>
                    <a
                        href="/categories"
                        class="mt-4 px-6 py-3 bg-[#0D903A] text-white rounded-full font-semibold hover:bg-[#096b2b] transition-colors duration-300"
                    >
                        Back to Categories
                    </a>
                </div>
            )
        }
    </section>
</BaseLayout>

<script>
    const sortSelect = document.getElementById("sort-select") as HTMLSelectElement;
    const officeGrid = document.getElementById("office-grid");
    const loadMoreBtn = document.getElementById("load-more-btn");
    const loadMoreContainer = document.getElementById("load-more-container");
    const noResultsMsg = document.getElementById("no-results-msg");
    const resultCount = document.getElementById("result-count");

    const filterCity = document.getElementById("filter-city") as HTMLSelectElement;
    const filterPrice = document.getElementById("filter-price") as HTMLSelectElement;
    const filterRating = document.getElementById("filter-rating") as HTMLSelectElement;

    let visibleCount = 9;
    const ITEMS_PER_PAGE = 9;

    if (sortSelect && officeGrid && filterCity && filterPrice && filterRating) {
        // Collect all card elements once
        const cards = Array.from(officeGrid.children) as HTMLElement[];

         // Helper to parse price string "Rp 18.560.000" -> 18560000
        const parsePrice = (priceStr: string) => {
            if (!priceStr) return 0;
            return parseInt(priceStr.replace(/[^0-9]/g, ""));
        };

        const filterSortAndRender = () => {
             const criteria = sortSelect.value;
            const cityFilter = filterCity.value;
            const priceFilter = filterPrice.value;
            const ratingFilter = filterRating.value;

            let processedCards = [...cards];

             // 1. Filter
            if (cityFilter) {
                processedCards = processedCards.filter(c => c.getAttribute("data-location") === cityFilter);
            }
            if (priceFilter) {
                const maxPrice = parseInt(priceFilter);
                processedCards = processedCards.filter(c => parsePrice(c.getAttribute("data-price") || "") <= maxPrice);
            }
            if (ratingFilter) {
                const minRating = parseFloat(ratingFilter);
                 processedCards = processedCards.filter(c => parseFloat(c.getAttribute("data-rating") || "0") >= minRating);
            }

            // 2. Sort
            if (criteria === "price-low") {
                processedCards.sort((a, b) => {
                    return parsePrice(a.getAttribute("data-price") || "0") - parsePrice(b.getAttribute("data-price") || "0");
                });
            } else if (criteria === "price-high") {
                processedCards.sort((a, b) => {
                    return parsePrice(b.getAttribute("data-price") || "0") - parsePrice(a.getAttribute("data-price") || "0");
                });
            } else if (criteria === "rating") {
                processedCards.sort((a, b) => {
                    return parseFloat(b.getAttribute("data-rating") || "0") - parseFloat(a.getAttribute("data-rating") || "0");
                });
            }

            // 3. Render / Update Visibility
             if (processedCards.length === 0) {
                 if (noResultsMsg) noResultsMsg.classList.remove("hidden");
                 if (loadMoreBtn) loadMoreBtn.classList.add("hidden");
                 
                 // Hide all cards
                 cards.forEach(c => c.classList.add("hidden"));
                 if (resultCount) resultCount.textContent = "0";
            } else {
                if (noResultsMsg) noResultsMsg.classList.add("hidden");
                if (resultCount) resultCount.textContent = processedCards.length.toString();
                
                processedCards.forEach((card, index) => {
                    officeGrid.appendChild(card);
                    if (index < visibleCount) {
                        card.classList.remove("hidden");
                    } else {
                        card.classList.add("hidden");
                    }
                });

                // Hide excluded cards
                 const processedSet = new Set(processedCards);
                 cards.forEach(card => {
                     if (!processedSet.has(card)) {
                         card.classList.add("hidden");
                     }
                 });

                if (loadMoreBtn) {
                    if (visibleCount >= processedCards.length) {
                         loadMoreBtn.classList.add("hidden");
                    } else {
                         loadMoreBtn.classList.remove("hidden");
                    }
                }
            }
        };

        const onFilterChange = () => {
            visibleCount = ITEMS_PER_PAGE;
            filterSortAndRender();
        };

        sortSelect.addEventListener("change", filterSortAndRender);
        filterCity.addEventListener("change", onFilterChange);
        filterPrice.addEventListener("change", onFilterChange);
        filterRating.addEventListener("change", onFilterChange);

        if (loadMoreBtn) {
            loadMoreBtn.addEventListener("click", () => {
                visibleCount += ITEMS_PER_PAGE;
                filterSortAndRender(); 
            });
        }
    }
</script>
