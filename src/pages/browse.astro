---
import BaseLayout from "../layouts/BaseLayout.astro";
import OfficeCard from "../components/OfficeCard.astro";
import offices from "../data/offices.json";
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
import cities from "../data/cities.json";
import bannerImage from "../assets/images/backgrounds/banner.webp";

// Get search query from URL parameter
const searchQuery = Astro.url.searchParams.get("q") || "";

const title = searchQuery
    ? `Search: ${searchQuery} - FirstOffice`
    : "Browse Offices - FirstOffice";
---

<BaseLayout title={title}>
    <header class="flex flex-col w-full">
        <section
            id="Hero-Banner"
            class="relative flex flex-col lg:block lg:h-[434px]"
        >
            <div
                id="Hero-Text"
                class="relative z-10 flex flex-col w-full px-4 mt-8 lg:mt-[70px] lg:ml-[calc((100%-1130px)/2)] lg:w-full lg:max-w-[650px] h-fit rounded-[30px] border border-[#E0DEF7] p-6 lg:p-10 gap-6 lg:gap-[30px] bg-white"
            >
                <div
                    class="flex items-center w-fit rounded-full py-2 px-4 gap-[10px] bg-[#000929]"
                >
                    <span class="font-semibold text-white text-sm lg:text-base"
                        >Browse Offices</span
                    >
                </div>
                <h1
                    class="font-extrabold text-[36px] lg:text-[50px] leading-[46px] lg:leading-[60px]"
                >
                    Find Your Perfect <br />
                    <span class="text-[#0D903A]">Workspace</span>
                </h1>
                <p
                    class="text-base lg:text-lg leading-7 lg:leading-8 text-[#000929]"
                >
                    Search specifically for what you need. From location to
                    amenities, find the office that fits your business style.
                </p>
            </div>
            <div
                id="Hero-Image"
                class="mt-8 lg:mt-0 w-full lg:absolute lg:right-0 lg:top-0 lg:w-[calc(100%-((100%-1130px)/2)-305px)] h-[300px] lg:h-[434px] rounded-[30px] lg:rounded-bl-[40px] overflow-hidden"
            >
                <Image
                    src={bannerImage}
                    class="w-full h-full object-cover"
                    alt="hero background"
                />
            </div>
        </section>
    </header>

    <section
        id="Search-Section"
        class="flex flex-col gap-[30px] w-full max-w-screen-xl mx-auto mt-10 px-4"
    >
        <div class="w-full max-w-[800px] mx-auto">
            <div class="relative flex items-center w-full">
                <!-- Search Icon -->
                <div class="absolute left-6 pointer-events-none">
                    <svg
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                    >
                        <path
                            d="M11.5 21C16.7467 21 21 16.7467 21 11.5C21 6.25329 16.7467 2 11.5 2C6.25329 2 2 6.25329 2 11.5C2 16.7467 6.25329 21 11.5 21Z"
                            stroke="#000929"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"></path>
                        <path
                            d="M22 22L20 20"
                            stroke="#000929"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"></path>
                    </svg>
                </div>
                <input
                    type="text"
                    id="search-input"
                    placeholder="Search by name, city, location..."
                    class="w-full h-[60px] pl-[60px] pr-6 rounded-full border border-[#E0DEF7] bg-white font-semibold text-lg text-[#000929] placeholder-[#A0A3BD] focus:outline-none focus:ring-2 focus:ring-[#0D903A] transition-all"
                />
            </div>
        </div>
    </section>

    <section
        id="Results-Section"
        class="flex flex-col gap-[30px] w-full max-w-screen-xl mx-auto mt-10 lg:mt-[50px] mb-10 lg:mb-[120px] px-4"
    >
        <div class="flex flex-col gap-4 hidden" id="results-header">
            <div
                class="flex flex-col md:flex-row items-center justify-between gap-4"
            >
                <h2 class="font-bold text-xl leading-[30px] text-[#000929]">
                    Showing <span id="result-count" class="text-[#0D903A]"
                        >0</span
                    > Offices
                </h2>
                <div class="flex items-center gap-3">
                    <span class="text-[#000929] font-medium">Sort by:</span>
                    <div class="relative">
                        <select
                            id="sort-select"
                            class="appearance-none bg-white border border-[#E0DEF7] rounded-full px-5 py-3 pr-10 text-[#000929] font-semibold focus:outline-none focus:ring-2 focus:ring-[#0D903A] cursor-pointer"
                        >
                            <option value="recommended">Recommended</option>
                            <option value="price-low">Lowest Price</option>
                            <option value="price-high">Highest Price</option>
                            <option value="rating">Highest Rating</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#000929]"
                        >
                            <Icon name="lucide:chevron-down" class="w-4 h-4" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div
                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-5 rounded-[20px] border border-[#E0DEF7] bg-white"
            >
                <!-- City Filter -->
                <div class="flex flex-col gap-2">
                    <label for="filter-city" class="font-bold text-[#000929]"
                        >City</label
                    >
                    <div class="relative">
                        <select
                            id="filter-city"
                            class="w-full appearance-none bg-white border border-[#E0DEF7] rounded-full px-4 py-2 pr-10 text-[#000929] font-medium focus:outline-none focus:ring-2 focus:ring-[#0D903A] cursor-pointer"
                        >
                            <option value="">All Cities</option>
                            {
                                cities.map((city) => (
                                    <option value={city.name}>
                                        {city.name}
                                    </option>
                                ))
                            }
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#000929]"
                        >
                            <Icon name="lucide:chevron-down" class="w-4 h-4" />
                        </div>
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="flex flex-col gap-2">
                    <label
                        for="filter-category"
                        class="font-bold text-[#000929]">Category</label
                    >
                    <div class="relative">
                        <select
                            id="filter-category"
                            class="w-full appearance-none bg-white border border-[#E0DEF7] rounded-full px-4 py-2 pr-10 text-[#000929] font-medium focus:outline-none focus:ring-2 focus:ring-[#0D903A] cursor-pointer"
                        >
                            <option value="">All Categories</option>
                            <option value="Serviced Office"
                                >Serviced Office</option
                            >
                            <option value="Virtual Office"
                                >Virtual Office</option
                            >
                            <option value="Managed Office"
                                >Managed Office</option
                            >
                            <option value="Shell and Core">Shell & Core</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#000929]"
                        >
                            <Icon name="lucide:chevron-down" class="w-4 h-4" />
                        </div>
                    </div>
                </div>

                <!-- Price Filter -->
                <div class="flex flex-col gap-2">
                    <label for="filter-price" class="font-bold text-[#000929]"
                        >Max Price</label
                    >
                    <div class="relative">
                        <select
                            id="filter-price"
                            class="w-full appearance-none bg-white border border-[#E0DEF7] rounded-full px-4 py-2 pr-10 text-[#000929] font-medium focus:outline-none focus:ring-2 focus:ring-[#0D903A] cursor-pointer"
                        >
                            <option value="">Any Price</option>
                            <option value="10000000">&lt; Rp 10.000.000</option>
                            <option value="20000000">&lt; Rp 20.000.000</option>
                            <option value="50000000">&lt; Rp 50.000.000</option>
                            <option value="100000000"
                                >&lt; Rp 100.000.000</option
                            >
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#000929]"
                        >
                            <Icon name="lucide:chevron-down" class="w-4 h-4" />
                        </div>
                    </div>
                </div>

                <!-- Rating Filter -->
                <div class="flex flex-col gap-2">
                    <label for="filter-rating" class="font-bold text-[#000929]"
                        >Rating</label
                    >
                    <div class="relative">
                        <select
                            id="filter-rating"
                            class="w-full appearance-none bg-white border border-[#E0DEF7] rounded-full px-4 py-2 pr-10 text-[#000929] font-medium focus:outline-none focus:ring-2 focus:ring-[#0D903A] cursor-pointer"
                        >
                            <option value="">Any Rating</option>
                            <option value="4.5">4.5+ Stars</option>
                            <option value="4">4+ Stars</option>
                            <option value="3">3+ Stars</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#000929]"
                        >
                            <Icon name="lucide:chevron-down" class="w-4 h-4" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div
            id="results-grid"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-[30px]"
        >
            {
                offices.map((office) => (
                    <div
                        class="office-card-item hidden"
                        data-slug={office.slug}
                        data-category={office.category}
                        data-location={office.location}
                        data-price={office.price}
                        data-rating={office.rating}
                    >
                        <OfficeCard office={office} />
                    </div>
                ))
            }
        </div>
        <p
            id="no-results-msg"
            class="hidden text-center text-xl text-gray-500 mt-10"
        >
            No offices found matching your search.
        </p>
        <p id="initial-msg" class="text-center text-xl text-gray-500 mt-10">
            Start typing to find your dream office.
        </p>
    </section>
</BaseLayout>

<script define:vars={{ offices, searchQuery }}>
    window.officeData = offices;
    window.initialSearchQuery = searchQuery;
</script>

<script>
    import Fuse from "fuse.js";

    const searchInput = document.getElementById(
        "search-input",
    ) as HTMLInputElement;
    const noResultsMsg = document.getElementById("no-results-msg");
    const initialMsg = document.getElementById("initial-msg");
    const allCards = document.querySelectorAll(".office-card-item");
    const sortSelect = document.getElementById(
        "sort-select",
    ) as HTMLSelectElement;
    const resultsHeader = document.getElementById("results-header");
    const resultCount = document.getElementById("result-count");
    const resultsGrid = document.getElementById("results-grid");

    const filterCity = document.getElementById(
        "filter-city",
    ) as HTMLSelectElement;
    const filterCategory = document.getElementById(
        "filter-category",
    ) as HTMLSelectElement;
    const filterPrice = document.getElementById(
        "filter-price",
    ) as HTMLSelectElement;
    const filterRating = document.getElementById(
        "filter-rating",
    ) as HTMLSelectElement;

    // Store current search results to allow sorting/filtering
    let currentResults: any[] = [];

    // Initialize Fuse with the data passed from the server
    // @ts-ignore
    const fuse = new Fuse(window.officeData, {
        keys: ["name", "location", "address", "description"],
        threshold: 0.4,
    });

    // Helper to parse price string "Rp 18.560.000" -> 18560000
    const parsePrice = (priceStr: string) => {
        if (!priceStr) return 0;
        return parseInt(priceStr.replace(/[^0-9]/g, ""));
    };

    const renderResults = () => {
        if (
            !sortSelect ||
            !filterCity ||
            !filterCategory ||
            !filterPrice ||
            !filterRating
        )
            return;

        const criteria = sortSelect.value;
        const cityFilter = filterCity.value;
        const categoryFilter = filterCategory.value;
        const priceFilter = filterPrice.value;
        const ratingFilter = filterRating.value;

        // 1. Start with search results
        let processedResults = [...currentResults];

        // 2. Apply Filters
        if (cityFilter) {
            processedResults = processedResults.filter(
                (r) => r.item.location === cityFilter,
            );
        }
        if (categoryFilter) {
            processedResults = processedResults.filter(
                (r) => r.item.category === categoryFilter,
            );
        }
        if (priceFilter) {
            const maxPrice = parseInt(priceFilter);
            processedResults = processedResults.filter(
                (r) => parsePrice(r.item.price) <= maxPrice,
            );
        }
        if (ratingFilter) {
            const minRating = parseFloat(ratingFilter);
            processedResults = processedResults.filter(
                (r) => r.item.rating >= minRating,
            );
        }

        // 3. Apply Sorting
        if (criteria === "price-low") {
            processedResults.sort(
                (a, b) => parsePrice(a.item.price) - parsePrice(b.item.price),
            );
        } else if (criteria === "price-high") {
            processedResults.sort(
                (a, b) => parsePrice(b.item.price) - parsePrice(a.item.price),
            );
        } else if (criteria === "rating") {
            processedResults.sort((a, b) => b.item.rating - a.item.rating);
        }
        // 'recommended' uses original order from Fuse (which is already in processedResults)

        if (noResultsMsg && resultsHeader && resultsGrid) {
            if (processedResults.length === 0) {
                // If search query was empty, we hide everything (handled in input listener).
                // If we are here, currentResults has items (or is empty and we handled it? No wait.)

                if (currentResults.length === 0) {
                    // Fuse found nothing
                    resultsHeader.classList.add("hidden");
                    noResultsMsg.classList.remove("hidden");
                    noResultsMsg.textContent =
                        "No offices found matching your search.";
                } else {
                    // Fuse found things, but filters hidden them
                    resultsHeader.classList.remove("hidden");
                    noResultsMsg.classList.remove("hidden");
                    noResultsMsg.textContent =
                        "No offices found matching the selected filters.";
                }

                allCards.forEach((card) => card.classList.add("hidden"));
            } else {
                noResultsMsg.classList.add("hidden");
                resultsHeader.classList.remove("hidden");
                if (resultCount)
                    resultCount.textContent =
                        processedResults.length.toString();

                // Reorder DOM
                // First, map available cards (we have them in allCards)
                const cardMap: Record<string, Element> = {};
                allCards.forEach((card) => {
                    const slug = card.getAttribute("data-slug");
                    if (slug) cardMap[slug] = card;
                    card.classList.add("hidden");
                });

                // Append/Show in sorted order
                processedResults.forEach((r) => {
                    const card = cardMap[r.item.slug];
                    if (card) {
                        card.classList.remove("hidden");
                        resultsGrid.appendChild(card);
                    }
                });
            }
        }
    };

    if (
        searchInput &&
        initialMsg &&
        noResultsMsg &&
        sortSelect &&
        filterCity &&
        filterCategory &&
        filterPrice &&
        filterRating
    ) {
        // Read query from URL parameters (client-side)
        const urlParams = new URLSearchParams(window.location.search);
        const queryFromUrl = urlParams.get("q") || "";

        // Auto-search if query parameter exists
        if (queryFromUrl && queryFromUrl.length > 0) {
            // Set the input value
            searchInput.value = queryFromUrl;

            initialMsg.classList.add("hidden");

            currentResults = fuse.search(queryFromUrl);
            renderResults();
        }

        searchInput.addEventListener("input", (e) => {
            const target = e.target as HTMLInputElement;
            const query = target.value.trim();

            if (query.length === 0) {
                // Empty state: Show initial message, hide results
                initialMsg.classList.remove("hidden");
                noResultsMsg.classList.add("hidden");
                if (resultsHeader) resultsHeader.classList.add("hidden");
                allCards.forEach((card) => card.classList.add("hidden"));
                currentResults = []; // Clear results
                return;
            }

            initialMsg.classList.add("hidden");

            currentResults = fuse.search(query);
            renderResults();
        });

        sortSelect.addEventListener("change", () => {
            renderResults();
        });
        filterCity.addEventListener("change", renderResults);
        filterCategory.addEventListener("change", renderResults);
        filterPrice.addEventListener("change", renderResults);
        filterRating.addEventListener("change", renderResults);
    }
</script>
