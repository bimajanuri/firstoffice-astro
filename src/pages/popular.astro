---
import BaseLayout from "../layouts/BaseLayout.astro";
import OfficeCard from "../components/OfficeCard.astro";

import offices from "../data/offices.json";
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";

// Import Hero Image (Reusing homepage banner or a specific one)
import bannerImage from "../assets/images/backgrounds/banner.webp";

const popularOffices = offices.filter((office) => office.isPopular);
const title = "Popular Offices - FirstOffice";
---

<BaseLayout title={title}>
    <header class="flex flex-col w-full">
        <section
            id="Hero-Banner"
            class="relative flex flex-col lg:block lg:h-[434px]"
        >
            <div
                id="Hero-Text"
                class="relative z-10 flex flex-col w-full px-4 mt-8 lg:mt-[70px] lg:ml-[calc((100%-1130px)/2)] lg:w-full lg:max-w-[650px] h-fit rounded-[30px] border border-[#E0DEF7] p-6 lg:p-10 gap-6 lg:gap-[30px] bg-white"
            >
                <div
                    class="flex items-center w-fit rounded-full py-2 px-4 gap-[10px] bg-[#000929]"
                >
                    <span class="font-semibold text-white text-sm lg:text-base"
                        >Popular Choice</span
                    >
                </div>
                <h1
                    class="font-extrabold text-[36px] lg:text-[50px] leading-[46px] lg:leading-[60px]"
                >
                    Most Popular <br />
                    <span class="text-[#0D903A]">Offices for You</span>
                </h1>
                <p
                    class="text-base lg:text-lg leading-7 lg:leading-8 text-[#000929]"
                >
                    Discover the most sought-after office spaces, curated
                    top-rated environments for your business growth.
                </p>
            </div>
            <div
                id="Hero-Image"
                class="mt-8 lg:mt-0 w-full lg:absolute lg:right-0 lg:top-0 lg:w-[calc(100%-((100%-1130px)/2)-305px)] h-[300px] lg:h-[434px] rounded-[30px] lg:rounded-bl-[40px] overflow-hidden"
            >
                <Image
                    src={bannerImage}
                    class="w-full h-full object-cover"
                    alt="hero background"
                />
            </div>
        </section>
    </header>
    <section
        id="Popular-Offices"
        class="flex flex-col gap-[30px] w-full max-w-screen-xl mx-auto mt-10 lg:mt-[70px] mb-10 lg:mb-[120px] px-4"
    >
        <div
            class="flex flex-col md:flex-row items-center justify-between gap-4"
        >
            <h2
                class="font-bold text-[28px] lg:text-[32px] leading-[40px] lg:leading-[48px] text-nowrap text-center lg:text-left"
            >
                Browse Popular Offices
            </h2>
            <div class="flex items-center gap-3">
                <span class="text-[#000929] font-medium">Sort by:</span>
                <div class="relative">
                    <select
                        id="sort-select"
                        class="appearance-none bg-white border border-[#E0DEF7] rounded-full px-5 py-3 pr-10 text-[#000929] font-semibold focus:outline-none focus:ring-2 focus:ring-[#0D903A] cursor-pointer"
                    >
                        <option value="recommended">Recommended</option>
                        <option value="price-low">Lowest Price</option>
                        <option value="price-high">Highest Price</option>
                        <option value="rating">Highest Rating</option>
                    </select>
                    <div
                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#000929]"
                    >
                        <Icon name="lucide:chevron-down" class="w-4 h-4" />
                    </div>
                </div>
            </div>
        </div>
        <div
            id="office-grid"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-[30px]"
        >
            {
                popularOffices.length > 0 ? (
                    popularOffices.map((office, index) => (
                        <div
                            class={`office-card-item ${index >= 9 ? "hidden" : ""}`}
                            data-price={office.price}
                            data-rating={office.rating}
                        >
                            <OfficeCard office={office} />
                        </div>
                    ))
                ) : (
                    <p class="col-span-1 sm:col-span-2 lg:col-span-3 text-center text-xl text-gray-500">
                        No popular offices found at the moment.
                    </p>
                )
            }
        </div>

        {
            popularOffices.length > 9 && (
                <div class="flex justify-center mt-10">
                    <button
                        id="load-more-btn"
                        class="px-8 py-4 bg-white border border-[#E0DEF7] rounded-full font-bold text-[#000929] hover:bg-gray-50 transition-colors"
                    >
                        View More Offices
                    </button>
                </div>
            )
        }
    </section>

    <script>
        const sortSelect = document.getElementById(
            "sort-select",
        ) as HTMLSelectElement;
        const officeGrid = document.getElementById("office-grid");
        const loadMoreBtn = document.getElementById("load-more-btn");

        let visibleCount = 9;
        const ITEMS_PER_PAGE = 9;

        if (sortSelect && officeGrid) {
            // Collect all card elements once
            // Note: The children are div.office-card-item
            const cards = Array.from(
                officeGrid.querySelectorAll(".office-card-item"),
            ) as HTMLElement[];

            // Helper to parse price string "Rp 18.560.000" -> 18560000
            const parsePrice = (priceStr: string) => {
                if (!priceStr) return 0;
                return parseInt(priceStr.replace(/[^0-9]/g, ""));
            };

            const updateVisibility = (sortedCards: HTMLElement[]) => {
                // Clear grid content (conceptually)
                // Actually we just re-append them in order, which moves them.

                sortedCards.forEach((card, index) => {
                    officeGrid.appendChild(card);
                    if (index < visibleCount) {
                        card.classList.remove("hidden");
                    } else {
                        card.classList.add("hidden");
                    }
                });

                // Update Load More Button
                if (loadMoreBtn) {
                    if (visibleCount >= sortedCards.length) {
                        loadMoreBtn.classList.add("hidden");
                    } else {
                        loadMoreBtn.classList.remove("hidden");
                    }
                }
            };

            const sortAndRender = () => {
                const criteria = sortSelect.value;
                const currentCards = [...cards]; // Copy original array references

                if (criteria === "price-low") {
                    currentCards.sort((a, b) => {
                        const priceA = parsePrice(
                            a.getAttribute("data-price") || "0",
                        );
                        const priceB = parsePrice(
                            b.getAttribute("data-price") || "0",
                        );
                        return priceA - priceB;
                    });
                } else if (criteria === "price-high") {
                    currentCards.sort((a, b) => {
                        const priceA = parsePrice(
                            a.getAttribute("data-price") || "0",
                        );
                        const priceB = parsePrice(
                            b.getAttribute("data-price") || "0",
                        );
                        return priceB - priceA;
                    });
                } else if (criteria === "rating") {
                    currentCards.sort((a, b) => {
                        const ratingA = parseFloat(
                            a.getAttribute("data-rating") || "0",
                        );
                        const ratingB = parseFloat(
                            b.getAttribute("data-rating") || "0",
                        );
                        return ratingB - ratingA;
                    });
                }
                // 'recommended' - use original DOM order (which matches 'cards' array index since we grabbed it initially)
                // No sorting needed on currentCards in that case.

                // Reset visible count on sort change?
                // Usually good UX to reset to page 1 to show top results.
                // Or keep current visible count?
                // Let's keep current visible count to avoid "collapsing" the list if user loaded more.
                // But if they sort by "lowest price", the lowest might be hidden if we don't reset or re-evaluate.
                // Actually, logic above: "if index < visibleCount -> remove hidden".
                // So the *top* sorted items will be visible. This is correct.

                updateVisibility(currentCards);
            };

            sortSelect.addEventListener("change", () => {
                // Should we reset visibleCount on sort?
                // User expects to see the top sorted items.
                // If they loaded 50 items, they probably want to see the 50 sorted items.
                // If they only loaded 9, they see top 9 sorted.
                // So keeping visibleCount seems safer/better UX than resetting to 9.
                sortAndRender();
            });

            if (loadMoreBtn) {
                loadMoreBtn.addEventListener("click", () => {
                    visibleCount += ITEMS_PER_PAGE;
                    sortAndRender(); // Re-run visibility logic (sorting order stays same because select value hasn't changed)
                });
            }
        }
    </script>
</BaseLayout>
