---
import { Icon } from "astro-icon/components";
import bookings from "../data/bookings.json";
---

<form
    id="booking-form"
    class="flex flex-col gap-4 rounded-[20px] border border-[#E0DEF7] p-[30px] bg-white"
>
    <div class="flex flex-col sm:flex-row items-end gap-[16px]">
        <div class="flex flex-col w-full gap-2">
            <label for="trxId" class="font-semibold">Booking TRX ID</label>
            <div
                class="flex items-center rounded-full border border-[#000929] px-5 gap-[10px] transition-all duration-300 focus-within:ring-2 focus-within:ring-[#0D903A]"
            >
                <Icon name="lucide:receipt" class="w-6 h-6" />
                <input
                    type="text"
                    name="trxId"
                    id="trxId"
                    class="appearance-none outline-none w-full py-3 font-semibold placeholder:font-normal placeholder:text-[#000929]"
                    placeholder="Write your booking trx id"
                    required
                />
            </div>
        </div>
        <div class="flex flex-col w-full gap-2">
            <label for="phone" class="font-semibold">Phone Number</label>
            <div
                class="flex items-center rounded-full border border-[#000929] px-5 gap-[10px] transition-all duration-300 focus-within:ring-2 focus-within:ring-[#0D903A]"
            >
                <Icon name="lucide:phone" class="w-6 h-6" />
                <input
                    type="tel"
                    name="phone"
                    id="phone"
                    class="appearance-none outline-none w-full py-3 font-semibold placeholder:font-normal placeholder:text-[#000929]"
                    placeholder="Write your valid number"
                    required
                />
            </div>
        </div>
        <button
            type="submit"
            class="flex items-center justify-center rounded-full p-[12px_30px] gap-3 bg-[#0D903A] font-bold text-[#F7F7FD] hover:bg-[#096b2b] transition-all duration-300 w-full sm:w-auto"
        >
            <span class="text-nowrap">Check Booking</span>
        </button>
    </div>

    <!-- Hidden UTM Fields -->
    <input type="hidden" name="utm_source" id="utm_source" />
    <input type="hidden" name="utm_medium" id="utm_medium" />
    <input type="hidden" name="utm_campaign" id="utm_campaign" />
    <input type="hidden" name="utm_term" id="utm_term" />
    <input type="hidden" name="utm_content" id="utm_content" />

    <!-- Error/Success Message -->
    <div id="form-message" class="hidden p-4 rounded-lg text-sm font-semibold">
    </div>
</form>

<script>
    import { getUTMParams } from "../scripts/utm-handler";

    // Populate UTM fields on load
    const utmParams = getUTMParams();
    if (utmParams) {
        (Object.keys(utmParams) as Array<keyof typeof utmParams>).forEach(
            (key) => {
                const input = document.getElementById(key);
                if (input)
                    (input as HTMLInputElement).value = utmParams[key] || "";
            },
        );
    }
</script>

<script define:vars={{ bookings }}>
    const form = document.getElementById("booking-form");
    const messageDiv = document.getElementById("form-message");

    form.addEventListener("submit", (e) => {
        e.preventDefault();

        const trxIdInput = document.getElementById("trxId");
        const phoneInput = document.getElementById("phone");

        const trxId = trxIdInput.value.trim();
        const phone = phoneInput.value.trim();

        // Clear previous messages
        messageDiv.classList.add("hidden");
        messageDiv.textContent = "";

        // Validation: Check if fields are empty
        if (!trxId || !phone) {
            showMessage(
                "Please fill in both Booking TRX ID and Phone Number.",
                "error",
            );
            return;
        }

        // Find matching booking
        const booking = bookings.find(
            (b) => b.bookingTrxId === trxId && b.customerPhone === phone,
        );

        if (booking) {
            // Booking found - navigate to booking page
            showMessage("Booking found! Redirecting...", "success");
            setTimeout(() => {
                window.location.href = `/booking/${booking.bookingTrxId}`;
            }, 1000);
        } else {
            // Booking not found
            showMessage(
                "Booking not found. Please check your TRX ID and Phone Number.",
                "error",
            );
        }
    });

    function showMessage(message, type) {
        messageDiv.textContent = message;
        messageDiv.classList.remove(
            "hidden",
            "bg-red-100",
            "text-red-700",
            "bg-green-100",
            "text-green-700",
        );

        if (type === "error") {
            messageDiv.classList.add("bg-red-100", "text-red-700");
        } else if (type === "success") {
            messageDiv.classList.add("bg-green-100", "text-green-700");
        }
    }
</script>
